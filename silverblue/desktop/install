#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/colors.sh"
source "$DOT_HOME/lib/constants.sh"
source "$DOT_HOME/lib/utils.sh"
source "$DOT_HOME/lib/logging.sh"

MODULE="desktop"
init_module_logging "$MODULE"

log_header "Installing Desktop Applications"

# Desktop applications to install via flatpak
DESKTOP_APPS=(
    "com.spotify.Client"                        # Spotify
    "org.mozilla.Thunderbird"                   # Thunderbird
    "com.slack.Slack"                           # Slack
    "org.gnome.Solanum"                         # Solanum (Pomodoro timer)
    "com.rafaelmardojai.Blanket"                # Blanket (Background sounds)
    "com.rtosta.zapzap"                         # ZapZap (WhatsApp)
    "io.gitlab.adhami3310.Impression"           # Impression (USB writer)
)

log_step "Installing desktop applications via Flatpak"

for app in "${DESKTOP_APPS[@]}"; do
    log_info "Installing $app"
    install_flatpak "$app"
done

# Install Ghostty terminal via COPR repository
log_step "Installing Ghostty terminal via COPR"

if ! command_exists ghostty; then
    log_info "Adding Ghostty COPR repository"
    
    # Source OS release info to get Fedora version
    . /etc/os-release
    
    # Check if repo already exists
    if [[ ! -f /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:scottames:ghostty.repo ]]; then
        log_command curl -fsSL "https://copr.fedorainfracloud.org/coprs/scottames/ghostty/repo/fedora-${VERSION_ID}/scottames-ghostty-fedora-${VERSION_ID}.repo" | sudo tee /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:scottames:ghostty.repo > /dev/null
        log_success "Ghostty COPR repository added"
    else
        log_info "Ghostty COPR repository already exists"
    fi
    
    log_info "Installing Ghostty via rpm-ostree"
    log_command sudo rpm-ostree refresh-md
    log_command sudo rpm-ostree install ghostty
    log_success "Ghostty installed (reboot required)"
else
    log_info "Ghostty already installed"
fi

log_success "Desktop applications installation completed"
finalize_module_logging "success"
