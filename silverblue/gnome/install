#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/colors.sh"
source "$DOT_HOME/lib/constants.sh"
source "$DOT_HOME/lib/utils.sh"
source "$DOT_HOME/lib/logging.sh"

MODULE="gnome"
init_module_logging "$MODULE"

log_header "Installing GNOME Extensions and Tools"

# Install GNOME extension: gnome-shell-go-to-last-workspace
log_step "Installing gnome-shell-go-to-last-workspace extension"

EXTENSION_NAME="gnome-shell-go-to-last-workspace@github.com"
REPO_URL="https://github.com/arjan/gnome-shell-go-to-last-workspace.git"
REPO_PATH="$REPOS_DIR/gnome-shell-go-to-last-workspace"
INSTALL_PATH="$HOME/.local/share/gnome-shell/extensions/$EXTENSION_NAME"

# Skip if already installed
if [[ -d "$INSTALL_PATH" ]]; then
    log_info "Extension already installed, skipping"
else
    # Create repositories directory if it doesn't exist
    mkdir -p "$REPOS_DIR"
    
    # Clone the repository
    log_info "Cloning repository"
    git clone --depth 50 "$REPO_URL" "$REPO_PATH"
    
    # Build and install
    cd "$REPO_PATH"
    log_info "Building and installing extension"
    make build
    make install
    log_success "Extension installed successfully"
fi

# Remove unwanted default packages
log_step "Removing unwanted default packages"
REMOVE_PACKAGES=(
    "gnome-terminal"
    "gnome-text-editor"
)

# Check which packages are actually installed before trying to remove
for pkg in "${REMOVE_PACKAGES[@]}"; do
    if package_installed "$pkg"; then
        log_info "Removing $pkg"
        remove_packages "$pkg"
    else
        log_info "$pkg not installed, skipping removal"
    fi
done

log_success "GNOME setup completed"
finalize_module_logging "success"
