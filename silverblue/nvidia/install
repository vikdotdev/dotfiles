#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/colors.sh"
source "$DOT_HOME/lib/constants.sh"
source "$DOT_HOME/lib/utils.sh"
source "$DOT_HOME/lib/logging.sh"
source "$DOT_HOME/lib/config.sh"

MODULE="nvidia"
init_module_logging "$MODULE"

log_header "Installing NVIDIA Drivers"

# Check if module should run on current profile
if check_profile_and_skip "nvidia"; then
    exit 0
fi

log_step "Installing NVIDIA drivers"

if ! package_installed "akmod-nvidia"; then
    log_info "Installing NVIDIA AKMOD drivers"
    install_packages "akmod-nvidia"
    
    log_warning "NVIDIA driver installation requires reboot to complete"
    log_info "After reboot, check driver with: nvidia-smi"
else
    log_info "NVIDIA drivers already installed"
fi

log_success "NVIDIA installation completed"
finalize_module_logging "success"