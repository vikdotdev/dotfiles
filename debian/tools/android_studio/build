#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$(dirname "$SCRIPT_DIR")")")"

source "$DOT_HOME/lib/debian/include.sh"

MODULE="android_studio"
init_module_logging "$MODULE"

log_header "Building Android Studio Configuration"

# Create zip of Android Studio settings
log_step "Creating Android Studio settings backup"

# Get downloads directory using XDG
DOWNLOADS_DIR="$(xdg-user-dir DOWNLOAD)"
if [[ -z "$DOWNLOADS_DIR" ]] || [[ ! -d "$DOWNLOADS_DIR" ]]; then
    DOWNLOADS_DIR="$HOME/Downloads"
    log_warning "XDG downloads directory not found, falling back to $DOWNLOADS_DIR"
fi
mkdir -p "$DOWNLOADS_DIR"

# Generate timestamp
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
ZIP_FILE="$DOWNLOADS_DIR/${TIMESTAMP}_android_studio_settings.zip"

# Create the zip file
if [[ -d "$SCRIPT_DIR/config" ]]; then
    cd "$SCRIPT_DIR"
    zip -r "$ZIP_FILE" config/ -q
    log_success "Created settings backup: $ZIP_FILE"
    log_info "You can import this in Android Studio via File > Manage IDE Settings > Import Settings"
else
    log_error "Config directory not found: $SCRIPT_DIR/config"
    finalize_module_logging "failed"
    exit 1
fi

log_success "Android Studio configuration completed"
finalize_module_logging "success"