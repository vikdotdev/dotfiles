#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/debian/include.sh"

MODULE="gnome"
init_module_logging "$MODULE"

log_header "Building GNOME Configuration"

# Apply GNOME settings
log_step "Applying GNOME settings"

if [[ -f "$SCRIPT_DIR/config/dconf.ini" ]]; then
    log_info "Loading dconf settings"
    log_command dconf load / < "$SCRIPT_DIR/config/dconf.ini"
else
    log_warning "dconf.ini not found, skipping GNOME settings"
fi

# Deploy custom CSS and themes
log_step "Deploying GTK themes"

# Deploy GTK 3.0 settings
if [[ -f "$SCRIPT_DIR/config/gtk-3.0/settings.ini" ]]; then
    log_info "Deploying GTK 3.0 settings"
    mkdir -p "$HOME/.config/gtk-3.0"
    cp "$SCRIPT_DIR/config/gtk-3.0/settings.ini" "$HOME/.config/gtk-3.0/settings.ini"
    log_info "GTK 3.0 settings deployed (dark theme + Emacs keybindings)"
fi

log_success "GNOME configuration completed"
finalize_module_logging "success"
