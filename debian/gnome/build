#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/debian/include.sh"

MODULE="gnome"
init_module_logging "$MODULE"

log_header "Building GNOME Configuration"

# Apply GNOME settings
log_step "Applying GNOME settings"

if [[ -f "$SCRIPT_DIR/config/dconf.ini" ]]; then
    log_info "Loading dconf settings"
    log_command dconf load / < "$SCRIPT_DIR/config/dconf.ini"
else
    log_warning "dconf.ini not found, skipping GNOME settings"
fi

# Deploy custom CSS and themes
log_step "Deploying GTK themes"

GTK_CONFIG_DIR="$HOME/.config/gtk-3.0"
GTK4_CONFIG_DIR="$HOME/.config/gtk-4.0"
mkdir -p "$GTK_CONFIG_DIR" "$GTK4_CONFIG_DIR"

if [[ -f "$SCRIPT_DIR/config/gtk3.css" ]]; then
    dest_file="$GTK_CONFIG_DIR/gtk.css"
    if [[ ! -f "$dest_file" ]] || ! cmp -s "$SCRIPT_DIR/config/gtk3.css" "$dest_file"; then
        cp "$SCRIPT_DIR/config/gtk3.css" "$dest_file"
        log_info "Deployed GTK3 custom CSS"
    else
        log_info "GTK3 custom CSS is already up to date"
    fi
fi

if [[ -f "$SCRIPT_DIR/config/gtk4.css" ]]; then
    dest_file="$GTK4_CONFIG_DIR/gtk.css"
    if [[ ! -f "$dest_file" ]] || ! cmp -s "$SCRIPT_DIR/config/gtk4.css" "$dest_file"; then
        cp "$SCRIPT_DIR/config/gtk4.css" "$dest_file"
        log_info "Deployed GTK4 custom CSS"
    else
        log_info "GTK4 custom CSS is already up to date"
    fi
fi

if [[ -f "$SCRIPT_DIR/config/settings3.ini" ]]; then
    dest_file="$GTK_CONFIG_DIR/settings.ini"
    if [[ ! -f "$dest_file" ]] || ! cmp -s "$SCRIPT_DIR/config/settings3.ini" "$dest_file"; then
        cp "$SCRIPT_DIR/config/settings3.ini" "$dest_file"
        log_info "Deployed GTK3 settings"
    else
        log_info "GTK3 settings are already up to date"
    fi
fi

log_success "GNOME configuration completed"
finalize_module_logging "success"
