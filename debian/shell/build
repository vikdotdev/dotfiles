#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_HOME="$(dirname "$(dirname "$SCRIPT_DIR")")"

source "$DOT_HOME/lib/debian/include.sh"

MODULE="shell"
init_module_logging "$MODULE"

log_header "Building Shell Configuration"

# Deploy shell configuration files from existing plans
log_step "Deploying shell configuration"

# Bash configuration
log_step "Installing bash configuration"

# Copy bash configuration files
if [[ -f "$SCRIPT_DIR/config/.bashrc" ]]; then
    cp "$SCRIPT_DIR/config/.bashrc" "$HOME/.bashrc"
    log_info "Deployed .bashrc"
fi

if [[ -f "$SCRIPT_DIR/config/.profile" ]]; then
    cp "$SCRIPT_DIR/config/.profile" "$HOME/.profile"
    log_info "Deployed .profile"
fi

if [[ -f "$SCRIPT_DIR/config/.bash_profile" ]]; then
    cp "$SCRIPT_DIR/config/.bash_profile" "$HOME/.bash_profile"
    log_info "Deployed .bash_profile"
fi

# Pry configuration
if [[ -f "$SCRIPT_DIR/config/.pryrc" ]]; then
    cp "$SCRIPT_DIR/config/.pryrc" "$HOME/.pryrc"
    log_info "Deployed .pryrc"
fi

# IRB configuration
if [[ -f "$SCRIPT_DIR/config/.irbrc" ]]; then
    cp "$SCRIPT_DIR/config/.irbrc" "$HOME/.irbrc"
    log_info "Deployed .irbrc"
fi

# Readline configuration
if [[ -f "$SCRIPT_DIR/config/.inputrc" ]]; then
    cp "$SCRIPT_DIR/config/.inputrc" "$HOME/.inputrc"
    log_info "Deployed .inputrc"
fi

# Deploy .profile.local example if it doesn't exist
if [[ ! -f "$HOME/.profile.local" ]] && [[ -f "$SCRIPT_DIR/config/.profile.local.example" ]]; then
    cp "$SCRIPT_DIR/config/.profile.local.example" "$HOME/.profile.local"
    log_info "Deployed .profile.local from example (customize as needed)"
fi

# Bash completions
log_step "Installing bash completions"
mkdir -p "$HOME/.bashrc.d"

# Source dot completions from top-level
if [[ -f "$DOT_HOME/completions/dot.bash" ]]; then
    cp "$DOT_HOME/completions/dot.bash" "$HOME/.bashrc.d/dot-completion.bash"
    log_info "Deployed dot command completions"
fi

log_success "Shell configuration completed"
finalize_module_logging "success"
